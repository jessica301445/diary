<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ‰‹å¸³æ—¥è¨˜ - å¯†ç¢¼ä¿è­·é€²éšç‰ˆ</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* æ ¸å¿ƒæ¨£å¼ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: Georgia, "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", serif;
      color: #5D4037;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .book-container {
      perspective: 1200px;
      width: 900px;
      height: 650px;
      position: relative;
    }

    .book {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      background: #8B4513;
      border-radius: 20px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.5);
      overflow: hidden;
      transition: width 0.6s ease;
    }

    .book-spine {
      position: absolute;
      left: 50%;
      top: 0;
      width: 5mm;
      height: 100%;
      background: linear-gradient(to right, #654321 0%, #8B4513 50%, #654321 100%);
      z-index: 50;
      transform: translateX(-50%);
      box-shadow: inset -8px 0 15px rgba(0,0,0,0.5), inset 8px 0 15px rgba(0,0,0,0.5);
    }

    .page {
      position: absolute;
      width: 50%;
      height: 100%;
      padding: 50px 45px;
      padding-bottom: 130px;
      background: white;
      overflow-y: auto;
      transform-style: preserve-3d;
      line-height: 1.8;
      font-size: 16px;
      background-image: repeating-linear-gradient(0deg, transparent, transparent 24px, #f5f5f5 24px, #f5f5f5 25px);
      box-shadow: inset 5px 0 10px rgba(0,0,0,0.1);
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-all;
    }

    .page.left { left: 0; border-radius: 20px 0 0 20px; }
    .page.right { right: 0; border-radius: 0 20px 20px 0; box-shadow: inset -5px 0 10px rgba(0,0,0,0.1); }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      color: #5D4037;
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 3px solid #D4AF37;
      letter-spacing: 1px;
    }

    .entry-actions { position: absolute; top: 20px; right: 20px; z-index: 100; }
    .entry-actions button {
      background: linear-gradient(145deg, #4CAF50, #45a049);
      color: white; border: none; padding: 6px 12px; margin-left: 5px; border-radius: 15px;
      cursor: pointer; font-family: inherit; font-size: 12px; font-weight: bold; transition: 0.3s;
    }
    .entry-actions .delete { background: linear-gradient(145deg, #f44336, #d32f2f); }

    .controls {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.98); padding: 15px 30px; border-radius: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 5000;
      display: flex; align-items: center; gap: 15px; backdrop-filter: blur(10px);
    }

    .controls button {
      background: linear-gradient(145deg, #FF9800, #F57C00); border: none; color: white;
      padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold;
      font-family: inherit; transition: 0.3s; white-space: nowrap;
    }
    .controls button:disabled { opacity: 0.4; cursor: not-allowed; }

    .entry-modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 6000; justify-content: center; align-items: center;
    }

    .modal-content {
      position: relative; background: #fffdf9; padding: 40px; border-radius: 25px;
      max-width: 650px; width: 90%; border: 3px solid #8B4513;
      font-family: Georgia, "Microsoft JhengHei", serif;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .modal-content textarea {
      width: 100%; height: 200px; padding: 15px; border: 2px solid #ddd; border-radius: 12px;
      font-family: inherit; font-size: 16px; outline: none; margin-top: 10px; resize: none;
    }

    .mood-selector { position: absolute; top: 35px; right: 40px; display: flex; gap: 8px; }
    .mood-icon { font-size: 24px; cursor: pointer; filter: grayscale(1); transition: 0.2s; border: 2px solid transparent; border-radius: 50%; }
    .mood-icon.selected { filter: grayscale(0); border-color: #D4AF37; transform: scale(1.1); }

    .photo-upload-container { margin-top: 15px; display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
    .image-preview { width: 80px; height: 80px; border: 2px dashed #D4AF37; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; background: #fff; }
    .image-preview img { width: 100%; height: 100%; object-fit: cover; }

    .page.cover { background: linear-gradient(135deg, #6d3b1f, #8B4513 40%, #5a2f18); color: #fff; text-align: center; }
    .page.back { background: linear-gradient(135deg, #4b2816, #6d3b1f 50%, #3f210f); color: #fff; text-align: center; }

    .book.cover-closed .book-spine { display: none; }
    .book.cover-closed .page.right { display: none; }
    .book.cover-closed .page.left { width: 100%; border-radius: 20px; }

    .flip-sheet{ position: absolute; top: 0; height: 100%; width: 50%; z-index: 2000; transform-style: preserve-3d; display: none; pointer-events: none; }
    .flip-face{ position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; padding: 50px 45px; backface-visibility: hidden; background-image: repeating-linear-gradient(0deg, transparent, transparent 24px, #f5f5f5 24px, #f5f5f5 25px); }
    .flip-sheet.ltr{ left: 0; transform-origin: right center; }
    .flip-sheet.ltr .flip-back{ transform: rotateY(180deg); }
    .flip-sheet.ltr.turn{ transition: transform 1.05s ease-in-out; transform: rotateY(180deg); }
    .flip-sheet.rtl{ right: 0; transform-origin: left center; }
    .flip-sheet.rtl .flip-back{ transform: rotateY(180deg); }
    .flip-sheet.rtl.turn{ transition: transform 1.05s ease-in-out; transform: rotateY(-180deg); }

    #export-container { position: absolute; left: -9999px; top: -9999px; width: 210mm; }

    /* å¯†ç¢¼è¼¸å…¥æ¡†æ¨£å¼ */
    .password-input {
      width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 12px;
      margin-bottom: 20px; font-family: inherit; font-size: 18px; text-align: center;
      outline: none; background: #fff;
    }
  </style>
</head>

<body>
  <div class="book-container">
    <div class="book" id="book">
      <div class="book-spine" id="spine"></div>
      <div class="page left" id="leftPage"></div>
      <div class="page right" id="rightPage"></div>
      <div id="flipSheet" class="flip-sheet">
        <div id="flipFront" class="flip-face"></div>
        <div id="flipBack" class="flip-face"></div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button id="btnPrev" onclick="prevPage()">â¬…ï¸ å‰ä¸€é </button>
    <span id="pageCounter" style="font-weight:bold; color:#8B4513;">å°é¢</span>
    <button id="btnNew" onclick="showNewEntryModal()">âœï¸ æ–°å¢æ—¥è¨˜</button>
    <button id="btnPdf" onclick="exportPDF()">ğŸ“„ åŒ¯å‡º PDF</button>
    <button id="btnNext" onclick="nextPage()">ä¸‹ä¸€é  â¡ï¸</button>
  </div>

  <div id="entryModal" class="entry-modal">
    <div class="modal-content">
      <h3 id="modalTitle">æ’°å¯«æ‰‹å¸³</h3>
      <div class="mood-selector">
        <span class="mood-icon" onclick="selectMood(0)">ğŸ˜Š</span>
        <span class="mood-icon" onclick="selectMood(1)">ğŸ˜</span>
        <span class="mood-icon" onclick="selectMood(2)">ğŸ˜†</span>
        <span class="mood-icon" onclick="selectMood(3)">ğŸ˜¢</span>
        <span class="mood-icon" onclick="selectMood(4)">ğŸ’”</span>
        <span class="mood-icon" onclick="selectMood(5)">ğŸ˜«</span>
      </div>
      
      <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px; font-size: 1.2em;">
        <label style="font-weight: bold;">æ—¥æœŸ</label>
        <input id="modalDate" type="date" style="padding: 12px; border-radius: 10px; border: 2px solid #ddd; font-family: inherit; font-size: 1em;" />
      </div>

      <textarea id="modalEntry" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹å‘¢ï¼Ÿ"></textarea>
      
      <div class="photo-upload-container">
        <span style="font-size: 14px; font-weight: bold;">æ’å…¥ç…§ç‰‡ï¼š</span>
        <div class="image-preview" onclick="document.getElementById('photoInput').click()">
          <span id="previewText" style="color:#D4AF37; font-size:24px;">+</span>
          <img id="previewImg" style="display:none;">
        </div>
        <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="handleImage(event)">
      </div>
      
      <div style="text-align: center; margin-top: 25px;">
        <button onclick="cancelEdit()" style="padding:10px 25px; border-radius:20px; border:none; cursor:pointer; margin-right:15px; background:#eee;">å–æ¶ˆ</button>
        <button onclick="saveEntry()" style="background:#4CAF50; color:white; padding:10px 25px; border-radius:20px; border:none; cursor:pointer; font-weight:bold;">ğŸ’¾ å„²å­˜</button>
      </div>
    </div>
  </div>

  <div id="passwordModal" class="entry-modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <h3 style="margin-bottom: 20px;">è«‹è¼¸å…¥é€šé—œå¯†èª</h3>
      <input type="password" id="passwordInput" class="password-input" placeholder="å¯†ç¢¼">
      <div style="display: flex; justify-content: center; gap: 15px;">
        <button onclick="closePasswordModal()" style="padding:10px 25px; border-radius:20px; border:none; cursor:pointer; background:#eee;">å–æ¶ˆ</button>
        <button onclick="checkPassword()" style="background:#4CAF50; color:white; padding:10px 25px; border-radius:20px; border:none; cursor:pointer; font-weight:bold;">ç¢ºèª</button>
      </div>
    </div>
  </div>

  <div id="export-container"><div id="pdf-content"></div></div>

  <script>
    const STORAGE_KEY = 'handbookEntries';
    const MOODS = ['ğŸ˜Š', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜¢', 'ğŸ’”', 'ğŸ˜«'];
    const DIARY_PASSWORD = '0000'; 
    
    let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let editingIndex = -1, viewMode = 'cover', currentPage = 0;
    let isFlipping = false;
    let currentMoodIdx = -1, currentImgBase64 = "";
    let isAuthenticated = false;

    window.onload = function() {
        isFlipping = false;
        renderPage();
    };

    function saveEntries(){
      entries.sort((a, b) => new Date(b.date) - new Date(a.date));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    function selectMood(idx) {
      currentMoodIdx = idx;
      document.querySelectorAll('.mood-icon').forEach((el, i) => el.classList.toggle('selected', i === idx));
    }

    function handleImage(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          currentImgBase64 = event.target.result;
          const img = document.getElementById('previewImg');
          img.src = currentImgBase64; img.style.display = 'block';
          document.getElementById('previewText').style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    }

    function getPageHtml(index, withActions = true){
      if (index === -100) return `<div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center;"><h1 style="font-size:48px; letter-spacing:5px;">æ‰‹å¸³æ—¥è¨˜</h1><p style="opacity:0.8; font-style:italic;">My Diary</p></div>`;
      if (index === -200) return `<div style="height:100%; display:flex; align-items:center; justify-content:center;"><h2>å°åº•</h2></div>`;
      if (index < 0 || index >= entries.length) return `<div style="text-align:center; margin-top:150px; color:#ccc; font-style:italic;"></div>`;
      
      const item = entries[index];
      const mood = item.mood !== undefined && item.mood !== -1 ? MOODS[item.mood] : '';
      const img = item.image ? `<img src="${item.image}" style="max-width:100%; border-radius:8px; margin-top:15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: block;">` : '';
      const actions = withActions ? `<div class="entry-actions"><button onclick="editEntry(${index})">ç·¨è¼¯</button><button class="delete" onclick="deleteEntry(${index})">åˆªé™¤</button></div>` : '';
      
      return `
        ${actions}
        <div class="page-header">
          <span>${item.date.replaceAll('-','/')}</span>
          <span style="font-size:24px;">${mood}</span>
        </div>
        <div style="white-space:pre-wrap;">${item.text}</div>
        ${img}
        <div style="position:absolute; bottom:20px; right:30px; color:#bbb; font-weight:bold;">${index + 1}</div>
      `;
    }

    function renderPage(){
      const book = document.getElementById('book'), left = document.getElementById('leftPage'), right = document.getElementById('rightPage');
      book.classList.remove('cover-closed');
      left.style.display = ''; right.style.display = '';

      if (viewMode === 'cover'){
        book.classList.add('cover-closed');
        left.className = 'page left cover';
        left.innerHTML = getPageHtml(-100);
        right.innerHTML = '';
      } else if (viewMode === 'back'){
        const lastLeft = (entries.length % 2 === 0) ? entries.length - 2 : entries.length - 1;
        left.className = 'page left'; 
        left.innerHTML = getPageHtml(Math.max(0, lastLeft));
        right.className = 'page right back';
        right.innerHTML = getPageHtml(-200);
      } else {
        left.className = 'page left'; right.className = 'page right';
        left.innerHTML = getPageHtml(currentPage);
        right.innerHTML = getPageHtml(currentPage + 1);
      }
      updateNavButtons();
    }

    function flipTo(targetIdx, dir) {
      if(isFlipping) return;
      isFlipping = true;
      updateNavButtons();

      const sheet = document.getElementById('flipSheet');
      const front = document.getElementById('flipFront');
      const back = document.getElementById('flipBack');

      if(dir === 'rtl') {
          front.innerHTML = getPageHtml(currentPage + 1, false);
          back.innerHTML = getPageHtml(targetIdx, false);
      } else {
          front.innerHTML = getPageHtml(currentPage, false);
          back.innerHTML = getPageHtml(targetIdx + 1, false);
      }

      sheet.className = `flip-sheet ${dir}`;
      sheet.style.display = 'block';
      void sheet.offsetWidth; 
      sheet.classList.add('turn');

      setTimeout(() => {
          sheet.classList.remove('turn');
          sheet.style.display = 'none';
          currentPage = targetIdx;
          renderPage();
          isFlipping = false;
          updateNavButtons();
      }, 1100);
    }

    // å¯†ç¢¼é‚è¼¯
    function openPasswordModal() {
      document.getElementById('passwordInput').value = "";
      document.getElementById('passwordModal').style.display = 'flex';
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
    }

    function checkPassword() {
      const input = document.getElementById('passwordInput').value;
      if (input === DIARY_PASSWORD) {
        isAuthenticated = true;
        closePasswordModal();
        viewMode = 'content';
        currentPage = 0;
        renderPage();
      } else {
        alert("ä¸å¯ä»¥å·çœ‹åˆ¥äººæ—¥è¨˜");
        document.getElementById('passwordInput').value = "";
      }
    }

    function nextPage(){
      if(isFlipping) return;
      if(viewMode === 'cover'){ 
          if (!isAuthenticated) {
            openPasswordModal();
            return; 
          }
          viewMode = 'content'; 
          currentPage = 0; 
          renderPage(); 
          return; 
      }
      if(viewMode === 'content' && currentPage + 2 >= entries.length){ 
          viewMode = 'back'; 
          renderPage(); 
          return; 
      }
      if(viewMode === 'content') flipTo(currentPage + 2, 'rtl');
    }

    function prevPage(){
      if(isFlipping) return;
      if(viewMode === 'back'){ 
          viewMode = 'content'; 
          renderPage(); 
          return; 
      }
      if(viewMode === 'content' && currentPage <= 0){ 
          viewMode = 'cover'; 
          renderPage(); 
          return; 
      }
      if(viewMode === 'content') flipTo(Math.max(0, currentPage - 2), 'ltr');
    }

    function updateNavButtons(){
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');
      if (isFlipping) {
          btnPrev.disabled = true;
          btnNext.disabled = true;
      } else {
          btnPrev.disabled = (viewMode === 'cover');
          btnNext.disabled = (viewMode === 'back');
      }
      const counter = document.getElementById('pageCounter');
      if(viewMode === 'cover') counter.textContent = 'å°é¢';
      else if(viewMode === 'back') counter.textContent = 'å°åº•';
      else counter.textContent = `ç¬¬ ${currentPage+1}-${Math.min(currentPage+2, entries.length)} é  / å…± ${entries.length} é `;
    }

    function showNewEntryModal(){
      editingIndex = -1; currentMoodIdx = -1; currentImgBase64 = "";
      document.getElementById('modalTitle').textContent = 'æ’°å¯«æ–°æ—¥è¨˜';
      document.getElementById('modalEntry').value = "";
      document.getElementById('modalDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('previewImg').style.display = 'none';
      document.getElementById('previewText').style.display = 'block';
      document.querySelectorAll('.mood-icon').forEach(el => el.classList.remove('selected'));
      document.getElementById('entryModal').style.display = 'flex';
    }

    function editEntry(idx){
      editingIndex = idx; const item = entries[idx];
      document.getElementById('modalTitle').textContent = 'ç·¨è¼¯æ—¥è¨˜';
      document.getElementById('modalEntry').value = item.text;
      document.getElementById('modalDate').value = item.date;
      selectMood(item.mood);
      if(item.image) {
        currentImgBase64 = item.image;
        document.getElementById('previewImg').src = item.image;
        document.getElementById('previewImg').style.display = 'block';
        document.getElementById('previewText').style.display = 'none';
      } else {
        currentImgBase64 = ""; document.getElementById('previewImg').style.display = 'none';
        document.getElementById('previewText').style.display = 'block';
      }
      document.getElementById('entryModal').style.display = 'flex';
    }

    function saveEntry(){
      const text = document.getElementById('modalEntry').value.trim(), date = document.getElementById('modalDate').value;
      if(!text || !date) return alert('è«‹å¡«å¯«å®Œæ•´å…§å®¹');
      const data = { text, date, mood: currentMoodIdx, image: currentImgBase64 };
      if(editingIndex === -1) entries.unshift(data); else entries[editingIndex] = data;
      saveEntries();
      document.getElementById('entryModal').style.display = 'none';
      viewMode = 'content'; currentPage = 0; renderPage();
    }

    function deleteEntry(idx){ if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ entries.splice(idx, 1); saveEntries(); renderPage(); } }
    function cancelEdit(){ document.getElementById('entryModal').style.display = 'none'; }

    async function exportPDF(){
      if(!entries.length) return alert('ç„¡å…§å®¹å¯åŒ¯å‡º');
      const content = document.getElementById('pdf-content');
      let html = `<div style="font-family: Georgia, 'Microsoft JhengHei', serif; color: #5D4037;">`;
      html += `<h1 style="text-align:center; color:#8B4513;">æ‰‹å¸³æ—¥è¨˜</h1>`;
      entries.forEach(item => {
        const mood = item.mood !== -1 && item.mood !== undefined ? MOODS[item.mood] : '';
        const img = item.image ? `<img src="${item.image}" style="width:100%; border-radius:10px; margin-top:10px;">` : '';
        html += `<div style="margin:20px; padding:20px; border-left:5px solid #D4AF37; background:#fffdf9; page-break-inside:avoid;">
          <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding-bottom:5px;">
            <span style="font-weight:bold;">${item.date.replaceAll('-','/')}</span><span style="font-size:20px;">${mood}</span>
          </div>
          <div style="white-space:pre-wrap; margin-top:10px; line-height:1.8; word-wrap:break-word;">${item.text}</div>
          ${img}
        </div>`;
      });
      html += `</div>`;
      content.innerHTML = html;
      
      const opt = { 
        margin: 10, 
        filename: 'My-Diary.pdf', 
        html2canvas: { scale: 2, useCORS: true }, 
        jsPDF: { 
          unit: 'mm', format: 'a4', orientation: 'portrait',
          encryption: {
            userPassword: DIARY_PASSWORD,
            ownerPassword: DIARY_PASSWORD,
            userPermissions: ["print", "modify", "copy", "annot-forms"]
          }
        } 
      };
      try { await html2pdf().set(opt).from(content).save(); } catch (err) { alert("åŒ¯å‡º PDF æ™‚ç™¼ç”ŸéŒ¯èª¤"); }
      content.innerHTML = "";
    }

    renderPage();
  </script>
</body>
</html>