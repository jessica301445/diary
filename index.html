<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ‰‹å¸³æ—¥è¨˜ - å®‰å…¨æ¸²æŸ“ä¿®æ­£ç‰ˆ</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* --- æ ¸å¿ƒåŸºç¤æ¨£å¼ --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #f5f7fa; }

    body {
      font-family: Georgia, "Microsoft JhengHei", serif;
      color: #5D4037;
      display: flex; justify-content: center; align-items: center;
    }

    /* --- æ›¸æœ¬å®¹å™¨ --- */
    .book-container {
      perspective: 1200px;
      width: 900px; height: 650px;
      position: relative;
    }

    .book {
      width: 100%; height: 100%;
      position: relative;
      transform-style: preserve-3d;
      background: #8B4513;
      border-radius: 20px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.5);
    }

    /* --- é é¢æ¨£å¼ --- */
    .page {
      position: absolute; width: 50%; height: 100%;
      padding: 50px 30px 130px 30px; 
      background: white; overflow-y: auto;
      line-height: 24px; font-size: 16px;
      background-image: repeating-linear-gradient(0deg, #f0f0f0 0px, #f0f0f0 1px, transparent 1px, transparent 24px);
      background-attachment: local;
      box-shadow: inset 5px 0 10px rgba(0,0,0,0.1);
      word-wrap: break-word;
    }

    .page.left { left: 0; border-radius: 20px 0 0 20px; }
    .page.right { right: 0; border-radius: 0 20px 20px 0; }
    .page.cover { background: #8B4513; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; }

    .page-header {
      line-height: 24px; height: 48px;
      margin-bottom: 0px; 
      border-bottom: 2px solid #D4AF37; font-weight: bold; font-size: 20px;
      display: flex; justify-content: space-between; align-items: flex-end;
      padding-bottom: 4px;
    }

    /* --- æ‰‹æ©Ÿç«¯ RWD --- */
    @media (max-width: 768px) {
      .book-container { width: 95vw; height: 85vh; }
      .page { width: 100% !important; border-radius: 20px !important; }
      .page.right { display: none !important; }
      .controls { bottom: 0; width: 100%; border-radius: 0; justify-content: space-around; padding: 10px 5px; height: 80px; }
      .controls button { padding: 8px 5px; font-size: 12px; flex: 1; max-width: 70px; }
    }

    .controls {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.98); padding: 12px 25px; border-radius: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 5000;
      display: flex; align-items: center; gap: 10px;
    }
    .controls button { background: #FF9800; border: none; color: white; padding: 10px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }

    /* --- å½ˆçª— --- */
    .entry-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; justify-content: center; align-items: center; }
    .modal-content { background: #fffdf9; padding: 25px; border-radius: 25px; width: 90%; max-width: 500px; border: 3px solid #8B4513; position: relative; }
    .mood-icon { font-size: 22px; cursor: pointer; filter: grayscale(1); }
    .mood-icon.selected { filter: grayscale(0); transform: scale(1.2); }
    .modal-content textarea { width: 100%; height: 150px; margin-top: 15px; padding: 10px; border-radius: 10px; font-size: 16px; border: 1px solid #ddd; }

    /* --- PDF çµ‚æ¥µä¿®æ­£æ¨£å¼ --- */
    
    /* 1. å…¨çƒå”¯ä¸€çš„ PDF å…§å®¹å®¹å™¨ (åœ¨è¦–çª—æœ€ä¸Šæ–¹ä½†è¢«é®æ“‹) */
    #pdf-master-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 750px; /* å›ºå®šå¯¬åº¦ï¼Œç¢ºä¿æ‰‹æ©Ÿç«¯ä¸è·‘ç‰ˆ */
      background: #ffffff;
      z-index: 10; /* åº•å±¤ */
      display: none; /* å¹³æ™‚ä¸ä½”ç©ºé–“ */
      padding: 40px;
    }

    /* 2. çµ‚æ¥µéš±ç§é®ç½© (å®Œå…¨ä¸é€æ˜ï¼Œèˆ‡ APP èƒŒæ™¯åŒè‰²) */
    #pdf-privacy-mask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #f5f7fa; /* é€™è£¡å¿…é ˆèˆ‡ APP èƒŒæ™¯é¡è‰²å®Œå…¨ä¸€è‡´ */
      z-index: 99999; /* çµ•å°æœ€é«˜å±¤ç´š */
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    /* ç”Ÿæˆä¸­ç‹€æ…‹ */
    body.is-generating {
      overflow-y: auto !important;
      background: #ffffff !important;
    }
    body.is-generating #pdf-master-container {
      display: block !important;
    }
    body.is-generating #pdf-privacy-mask {
      display: flex !important;
    }
    body.is-generating .book-container, 
    body.is-generating .controls {
      visibility: hidden !important; /* éš±è—ä½†ä¿ç•™ç©ºé–“ï¼Œé˜²æ­¢ä½ˆå±€å¡Œé™· */
    }
  </style>
</head>

<body>
  <!-- æ›¸æœ¬èˆ‡æ§åˆ¶åˆ— -->
  <div class="book-container" id="mainApp">
    <div class="book" id="book">
      <div class="page left" id="leftPage"></div>
      <div class="page right" id="rightPage"></div>
    </div>
  </div>

  <div class="controls" id="controls">
    <button onclick="prevPage()">â¬…ï¸</button>
    <span id="pageCounter" style="font-size:12px; font-weight:bold;">å°é¢</span>
    <button onclick="showNewEntryModal()">âœï¸æ–°å¢</button>
    <button onclick="exportPDF()">ğŸ“„PDF</button>
    <button onclick="nextPage()">â¡ï¸</button>
  </div>

  <!-- å¯†ç¢¼å½ˆçª— -->
  <div id="passwordModal" class="entry-modal">
    <div class="modal-content" style="max-width: 300px; text-align: center;">
      <h3>é€šé—œå¯†èª</h3>
      <input type="password" id="passwordInput" style="width:100%; padding:10px; margin: 15px 0; text-align:center; border-radius:10px; border:1px solid #ddd;">
      <button onclick="checkPassword()" style="background:#4CAF50; color:white; padding:8px 25px; border:none; border-radius:20px; font-weight:bold;">ç¢ºèª</button>
    </div>
  </div>

  <!-- æ’°å¯«å½ˆçª— -->
  <div id="entryModal" class="entry-modal">
    <div class="modal-content">
      <h3 id="modalTitle">æ’°å¯«æ—¥è¨˜</h3>
      <textarea id="modalEntry" placeholder="ä»Šå¤©å¿ƒæƒ…å¦‚ä½•ï¼Ÿ"></textarea>
      <input id="modalDate" type="date" style="margin-top:10px;">
      <div style="text-align:center; margin-top:20px;">
        <button onclick="cancelEdit()" style="margin-right:10px;">å–æ¶ˆ</button>
        <button onclick="saveEntry()" style="background:#4CAF50; color:white; padding:8px 20px; border:none; border-radius:15px; font-weight:bold;">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- --- PDF ä¿®æ­£å€å¡Š --- -->
  <div id="pdf-master-container"></div>
  
  <div id="pdf-privacy-mask">
      <div style="background: white; padding: 40px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
          <div style="font-size: 50px; margin-bottom: 20px;">ğŸ”’</div>
          <div style="font-size: 20px; font-weight: bold; color: #8B4513; margin-bottom: 10px;">åŠ å¯†æª”æ¡ˆç”Ÿæˆä¸­</div>
          <div style="color: #666; font-size: 14px;">ç‚ºäº†ä¿è­·éš±ç§ï¼Œé è¦½ç•«é¢å·²æš«æ™‚é®è“‹...</div>
          <div style="margin-top: 25px; width: 200px; height: 4px; background: #eee; border-radius: 2px; overflow: hidden; margin-left: auto; margin-right: auto;">
              <div style="width: 50%; height: 100%; background: #FF9800; animation: loading 2s infinite ease-in-out;"></div>
          </div>
      </div>
  </div>

  <style>
    @keyframes loading {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(200%); }
    }
  </style>

  <script>
    const STORAGE_KEY = 'handbookEntries';
    const MOODS = ['ğŸ˜Š', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜¢', 'ğŸ˜«'];
    const DIARY_PASSWORD = '0000';
    let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let currentPage = 0, viewMode = 'cover', editingIndex = -1, isAuthenticated = false;

    // --- åˆå§‹åŒ–æ¸²æŸ“ (ç°¡åŒ–åŸæœ‰é‚è¼¯) ---
    function renderPage(){
      const left = document.getElementById('leftPage'), right = document.getElementById('rightPage');
      if (viewMode === 'cover'){
        left.className = 'page left cover';
        left.innerHTML = `<h1>æˆ‘çš„æ‰‹å¸³</h1><p style="margin-top:20px;">é»æ“Šå³ç®­é ­é–‹å§‹</p>`;
        right.style.display = 'none';
      } else {
        left.className = 'page left';
        left.innerHTML = getPageHtml(currentPage);
        right.style.display = window.innerWidth <= 768 ? 'none' : 'block';
        if (right.style.display === 'block') right.innerHTML = getPageHtml(currentPage + 1);
      }
      document.getElementById('pageCounter').textContent = viewMode === 'cover' ? 'å°é¢' : `${currentPage+1} / ${entries.length}`;
    }

    function getPageHtml(idx){
      if (idx < 0 || idx >= entries.length) return `<div style="text-align:center; padding-top:100px; color:#ccc;">ç©ºç™½é </div>`;
      const item = entries[idx];
      return `<div class="page-header"><span>${item.date}</span></div><div style="padding-top:20px;">${item.text}</div>`;
    }

    function checkPassword(){
      if(document.getElementById('passwordInput').value === DIARY_PASSWORD){
        isAuthenticated = true; document.getElementById('passwordModal').style.display = 'none';
        viewMode = 'content'; renderPage();
      } else { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); }
    }

    function nextPage(){
      if(viewMode === 'cover') {
        if(!isAuthenticated) { document.getElementById('passwordModal').style.display='flex'; return; }
        viewMode = 'content'; renderPage(); return;
      }
      const step = window.innerWidth <= 768 ? 1 : 2;
      if(currentPage + step < entries.length) { currentPage += step; renderPage(); }
    }

    function prevPage(){
      const step = window.innerWidth <= 768 ? 1 : 2;
      if(currentPage - step < 0) { viewMode = 'cover'; renderPage(); }
      else { currentPage -= step; renderPage(); }
    }

    function showNewEntryModal() {
        document.getElementById('modalEntry').value = "";
        document.getElementById('modalDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('entryModal').style.display = 'flex';
    }

    function saveEntry(){
        const text = document.getElementById('modalEntry').value, date = document.getElementById('modalDate').value;
        if(!text) return;
        entries.unshift({ text, date });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        document.getElementById('entryModal').style.display = 'none';
        renderPage();
    }

    function cancelEdit() { document.getElementById('entryModal').style.display = 'none'; }

    // --- çµ‚æ¥µä¿®æ­£ï¼šPDF åŒ¯å‡ºé‚è¼¯ ---
    async function exportPDF() {
      const container = document.getElementById('pdf-master-container');
      
      // 1. ç”Ÿæˆå…§å®¹
      container.innerHTML = `<h1 style="text-align:center; color:#8B4513; margin-bottom:40px;">æˆ‘çš„æ‰‹å¸³æ—¥è¨˜</h1>`;
      entries.forEach(item => {
        container.innerHTML += `
          <div style="padding:30px; border-bottom:2px solid #D4AF37; page-break-inside:avoid; background:white;">
            <div style="font-weight:bold; font-size:20px; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">${item.date}</div>
            <div style="font-size:16px; line-height:1.6; white-space:pre-wrap; color:#333;">${item.text}</div>
          </div>`;
      });

      // 2. é€²å…¥ã€Œç”Ÿæˆæ¨¡å¼ã€
      // é€™æœƒè®“å…§å®¹é¡¯ç¤ºåœ¨é é¢é ‚ç«¯ (0,0)ï¼Œä½†ä¸Šé¢æœƒè“‹è‘—ä¸€å€‹èˆ‡èƒŒæ™¯åŒè‰²çš„éš±ç§é®ç½©
      document.body.classList.add('is-generating');
      
      // 3. é—œéµï¼šçµ¦äºˆæ‰‹æ©Ÿç€è¦½å™¨å……è¶³çš„æ¸²æŸ“æ™‚é–“ (è§£æ±ºç©ºç™½é æ ¸å¿ƒ)
      await new Promise(resolve => setTimeout(resolve, 1500));

      const opt = {
        margin: 10,
        filename: 'My_Diary_Private.pdf',
        image: { type: 'jpeg', quality: 0.95 },
        // æŒ‡å®š windowWidth ç¢ºä¿ html2canvas ä»¥æ¨™æº–å¯¬åº¦æ“·å–ï¼Œä¸è¢«æ‰‹æ©Ÿè¢å¹•å¯¬åº¦å½±éŸ¿
        html2canvas: { 
            scale: 2, 
            useCORS: true, 
            scrollY: 0, 
            windowWidth: 800,
            logging: false 
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait', 
            encryption: { 
                userPassword: DIARY_PASSWORD, 
                ownerPassword: DIARY_PASSWORD,
                userPermissions: ["print", "modify", "copy", "annot-cards"]
            } 
        }
      };

      try {
        // ç›´æ¥å¾ container ç‰©ä»¶æŠ“å–ï¼Œå®ƒç¾åœ¨æ­£ä½æ–¼è¦–çª—é ‚å±¤(é›–ç„¶è¢«æ“‹ä½)
        await html2pdf().set(opt).from(container).save();
      } catch (err) {
        alert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–ç©ºé–“");
      }

      // 4. æ¢å¾©åŸç‹€
      document.body.classList.remove('is-generating');
      container.innerHTML = ""; 
    }

    window.onload = renderPage;
  </script>
</body>
</html>
