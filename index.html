<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ‰‹å¸³æ—¥è¨˜ - å®Œç¾ä¿®æ­£ç‰ˆ</title>

  <!-- jsPDF (ä¿ç•™ä½ åŸæœ¬çš„åŠ å¯†è¨­å®šç”¨æ³•) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- æ˜ç¢ºè¼‰å…¥ html2canvasï¼šè§£æ±º Safari ä¸Š window.html2canvas ä¸å­˜åœ¨çš„ç‹€æ³ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ä½ åŸæœ¬å°±æœ‰è¼‰å…¥ï¼ˆå¯ç•™è‘—ä¸å½±éŸ¿ï¼›æœ¬ç‰ˆåŒ¯å‡ºä¸ä¾è³´å®ƒï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* æ ¸å¿ƒåŸºç¤æ¨£å¼ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #f5f7fa; }

    body {
      font-family: Georgia, "Microsoft JhengHei", serif;
      color: #5D4037;
      display: flex; justify-content: center; align-items: center;
    }

    .book-container {
      perspective: 1200px;
      width: 900px; height: 650px;
      position: relative;
    }

    .book {
      width: 100%; height: 100%;
      position: relative;
      transform-style: preserve-3d;
      background: #8B4513;
      border-radius: 20px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.5);
    }

    /* é—œéµï¼šä¿®æ­£æ ¼ç·šå°é½Š */
    .page {
      position: absolute; width: 50%; height: 100%;
      padding: 50px 30px 130px 30px;
      background: white; overflow-y: auto;
      line-height: 24px;
      font-size: 16px;
      background-image: repeating-linear-gradient(0deg, #f0f0f0 0px, #f0f0f0 1px, transparent 1px, transparent 24px);
      background-attachment: local;
      box-shadow: inset 5px 0 10px rgba(0,0,0,0.1);
      word-wrap: break-word;
    }

    .page.left { left: 0; border-radius: 20px 0 0 20px; }
    .page.right { right: 0; border-radius: 0 20px 20px 0; }
    .page.cover { background: #8B4513; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; }

    .page-header {
      line-height: 24px; height: 48px;
      margin-bottom: 0px;
      border-bottom: 2px solid #D4AF37; font-weight: bold; font-size: 20px;
      display: flex; justify-content: space-between; align-items: flex-end;
      padding-bottom: 4px;
    }

    .entry-actions { position: absolute; top: 15px; right: 15px; z-index: 100; display: flex; gap: 5px; }
    .entry-actions button {
      background: #4CAF50; color: white; border: none; padding: 4px 10px;
      border-radius: 12px; cursor: pointer; font-size: 12px; font-weight: bold;
    }
    .entry-actions .delete { background: #f44336; }

    /* ç¿»é å‹•ç•« */
    .flip-sheet { position: absolute; top: 0; height: 100%; width: 50%; z-index: 2000; transform-style: preserve-3d; display: none; pointer-events: none; }
    .flip-face { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; padding: 50px 30px; backface-visibility: hidden; background-image: repeating-linear-gradient(0deg, #f0f0f0 0px, #f0f0f0 1px, transparent 1px, transparent 24px); }
    .flip-sheet.rtl { right: 0; transform-origin: left center; }
    .flip-sheet.rtl .flip-back { transform: rotateY(180deg); }
    .flip-sheet.rtl.turn { transition: transform 0.8s ease-in-out; transform: rotateY(-180deg); }

    /* æ‰‹æ©Ÿç«¯é©é… */
    @media (max-width: 768px) {
      .book-container { width: 95vw; height: 85vh; }
      .page { width: 100% !important; border-radius: 20px !important; }
      .page.right { display: none !important; }
      .controls { bottom: 0; width: 100%; border-radius: 0; justify-content: space-around; padding: 10px 5px; height: 80px; }
      .controls button { padding: 8px 5px; font-size: 12px; flex: 1; max-width: 70px; }
    }

    .controls {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.98); padding: 12px 25px; border-radius: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 5000;
      display: flex; align-items: center; gap: 10px;
    }
    .controls button { background: #FF9800; border: none; color: white; padding: 10px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }

    /* å½ˆçª—èˆ‡å¿ƒæƒ… */
    .entry-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; justify-content: center; align-items: center; }
    .modal-content { background: #fffdf9; padding: 25px; border-radius: 25px; width: 90%; max-width: 500px; border: 3px solid #8B4513; position: relative; }
    .mood-selector { position: absolute; top: 25px; right: 25px; display: flex; gap: 5px; }
    .mood-icon { font-size: 22px; cursor: pointer; filter: grayscale(1); }
    .mood-icon.selected { filter: grayscale(0); transform: scale(1.2); }
    .modal-content textarea { width: 100%; height: 150px; margin-top: 15px; padding: 10px; border-radius: 10px; font-size: 16px; border: 1px solid #ddd; }

    /* PDF æš«å­˜å®¹å™¨ï¼šä¸ç§»å‡ºè¦–çª—(é¿å… iOS ä¸æ¸²æŸ“)ï¼Œä½†ä½¿ç”¨è€…çœ‹ä¸åˆ° */
    #pdf-hidden-area{
      position: fixed;
      top: 0;
      left: 0;
      width: 800px;
      background: #fff;
      opacity: 0;
      pointer-events: none;
      z-index: 1;
    }

    .pdf-page{
      width: 800px;
      min-height: 1125px; /* ç´„ç­‰æ–¼ A4 æ¯”ä¾‹(800 * 297/210) */
      padding: 40px 40px 30px 40px;
      background: #fff;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    .pdf-title{
      text-align:center;
      color:#8B4513;
      margin-bottom: 24px;
      font-size: 28px;
      font-weight: 700;
    }

    .pdf-entry{
      padding: 18px 0;
      border-bottom: 2px solid #D4AF37;
      page-break-inside: avoid;
    }

    .pdf-entry-header{
      display:flex;
      justify-content:space-between;
      font-weight:700;
      font-size:18px;
      margin-bottom:10px;
      color:#333;
    }

    .pdf-entry-text{
      font-size:16px;
      line-height:1.65;
      white-space:pre-wrap;
      color:#222;
    }

    .pdf-entry img{
      width:100%;
      border-radius:10px;
      margin-top:12px;
      display:block;
    }

    /* ç”Ÿæˆ PDF é®ç½©ï¼šä½¿ç”¨è€…æ°¸é åªçœ‹åˆ°é€™å±¤ */
    #privacy-mask{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.85);
      z-index: 9999;
      color:#fff;
      font-weight:700;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding: 24px;
    }
  </style>
</head>

<body>
  <div class="book-container">
    <div class="book" id="book">
      <div class="page left" id="leftPage"></div>
      <div class="page right" id="rightPage"></div>
      <div id="flipSheet" class="flip-sheet">
        <div id="flipFront" class="flip-face"></div>
        <div id="flipBack" class="flip-face"></div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button onclick="prevPage()">â¬…ï¸</button>
    <span id="pageCounter" style="font-size:12px; font-weight:bold;">å°é¢</span>
    <button onclick="showNewEntryModal()">âœï¸æ–°å¢</button>
    <button onclick="exportPDF()">ğŸ“„PDF</button>
    <button onclick="nextPage()">â¡ï¸</button>
  </div>

  <div id="passwordModal" class="entry-modal">
    <div class="modal-content" style="max-width: 300px; text-align: center;">
      <h3>é€šé—œå¯†èª</h3>
      <input type="password" id="passwordInput" style="width:100%; padding:10px; margin: 15px 0; text-align:center; border-radius:10px; border:1px solid #ddd;">
      <button onclick="checkPassword()" style="background:#4CAF50; color:white; padding:8px 25px; border:none; border-radius:20px; font-weight:bold;">ç¢ºèª</button>
    </div>
  </div>

  <div id="entryModal" class="entry-modal">
    <div class="modal-content">
      <h3 id="modalTitle">æ’°å¯«æ—¥è¨˜</h3>
      <div class="mood-selector">
        <span class="mood-icon" onclick="selectMood(0)">ğŸ˜Š</span>
        <span class="mood-icon" onclick="selectMood(1)">ğŸ˜</span>
        <span class="mood-icon" onclick="selectMood(2)">ğŸ˜†</span>
        <span class="mood-icon" onclick="selectMood(3)">ğŸ˜¢</span>
        <span class="mood-icon" onclick="selectMood(4)">ğŸ˜«</span>
      </div>
      <input id="modalDate" type="date" style="width:150px; padding:8px; margin-top:10px; border-radius:8px; border:1px solid #ddd;">
      <textarea id="modalEntry" placeholder="ä»Šå¤©å¿ƒæƒ…å¦‚ä½•ï¼Ÿ"></textarea>
      <div style="margin-top:10px; display:flex; align-items:center; gap:10px; justify-content:flex-end;">
        <div id="previewBox" style="width:50px; height:50px; border:1px dashed #ccc; border-radius:5px; overflow:hidden;">
          <img id="previewImg" style="width:100%; height:100%; object-fit:cover; display:none;">
        </div>
        <button onclick="document.getElementById('photoInput').click()" style="font-size:12px;">ğŸ“·é¸ç…§ç‰‡</button>
        <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="handleImage(event)">
      </div>
      <div style="text-align:center; margin-top:20px;">
        <button onclick="cancelEdit()" style="padding:8px 20px; border-radius:15px; border:1px solid #ccc; margin-right:10px;">å–æ¶ˆ</button>
        <button onclick="saveEntry()" style="background:#4CAF50; color:white; padding:8px 20px; border:none; border-radius:15px; font-weight:bold;">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- PDF æš«å­˜å®¹å™¨ -->
  <div id="pdf-hidden-area"></div>

  <!-- éš±ç§é®ç½© -->
  <div id="privacy-mask">
    åŠ å¯†è™•ç†ä¸­<br>
    <span style="font-weight:400; color:#ddd;">æ­£åœ¨ç”Ÿæˆå—ä¿è­·çš„ PDF æª”æ¡ˆ...</span>
  </div>

  <script>
    const STORAGE_KEY = 'handbookEntries';
    const MOODS = ['ğŸ˜Š', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜¢', 'ğŸ˜«'];
    const DIARY_PASSWORD = '0000';

    let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let currentPage = 0, viewMode = 'cover', editingIndex = -1, currentImgBase64 = "", currentMoodIdx = -1, isAuthenticated = false, isFlipping = false;

    function renderPage(){
      const left = document.getElementById('leftPage'), right = document.getElementById('rightPage');
      if (viewMode === 'cover'){
        left.className = 'page left cover';
        left.innerHTML = `<h1>æˆ‘çš„æ‰‹å¸³</h1><p style="margin-top:20px; font-size:12px;">é»æ“Šå³ç®­é ­é–‹å§‹</p>`;
        right.style.display = 'none';
      } else {
        left.className = 'page left';
        left.innerHTML = getPageHtml(currentPage);
        if (window.innerWidth <= 768) {
          right.style.display = 'none';
        } else {
          right.style.display = 'block';
          right.innerHTML = getPageHtml(currentPage + 1);
        }
      }
      document.getElementById('pageCounter').textContent = viewMode === 'cover' ? 'å°é¢' : `${currentPage+1} / ${entries.length}`;
    }

    function getPageHtml(idx, hideActions = false){
      if (idx < 0 || idx >= entries.length) return `<div style="text-align:center; padding-top:100px; color:#ccc;">ç©ºç™½é </div>`;
      const item = entries[idx];
      const mood = item.mood !== undefined && item.mood !== -1 ? MOODS[item.mood] : '';
      const imgHtml = item.image ? `<img src="${item.image}" style="max-width:100%; border-radius:8px; margin-top:10px;">` : '';
      const actions = hideActions ? '' : `<div class="entry-actions"><button onclick="editEntry(${idx})">ç·¨è¼¯</button><button class="delete" onclick="deleteEntry(${idx})">åˆªé™¤</button></div>`;
      return `${actions}<div class="page-header"><span>${item.date.replaceAll('-','/')}</span><span>${mood}</span></div><div style="padding-top:4px; white-space:pre-wrap;">${item.text}</div>${imgHtml}`;
    }

    function flipTo(targetIdx) {
      if(isFlipping) return;
      isFlipping = true;
      const sheet = document.getElementById('flipSheet');
      const front = document.getElementById('flipFront'), back = document.getElementById('flipBack');
      front.innerHTML = getPageHtml(currentPage, true);
      back.innerHTML = getPageHtml(targetIdx, true);
      sheet.style.display = 'block';
      sheet.classList.add('rtl', 'turn');
      setTimeout(() => {
        sheet.classList.remove('turn'); sheet.style.display = 'none';
        currentPage = targetIdx; renderPage(); isFlipping = false;
      }, 800);
    }

    function checkPassword(){
      if(document.getElementById('passwordInput').value === DIARY_PASSWORD){
        isAuthenticated = true;
        document.getElementById('passwordModal').style.display = 'none';
        viewMode = 'content'; currentPage = 0; renderPage();
      } else { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); }
    }

    function nextPage(){
      if(viewMode === 'cover') {
        if(!isAuthenticated) { document.getElementById('passwordModal').style.display='flex'; return; }
        viewMode = 'content'; renderPage(); return;
      }
      const step = window.innerWidth <= 768 ? 1 : 2;
      if(currentPage + step < entries.length) flipTo(currentPage + step);
    }

    function prevPage(){
      const step = window.innerWidth <= 768 ? 1 : 2;
      if(currentPage - step < 0) { viewMode = 'cover'; renderPage(); }
      else { currentPage -= step; renderPage(); }
    }

    function selectMood(idx) {
      currentMoodIdx = idx;
      document.querySelectorAll('.mood-icon').forEach((el, i) => el.classList.toggle('selected', i === idx));
    }

    function showNewEntryModal(){
      editingIndex = -1; currentImgBase64 = ""; currentMoodIdx = -1;
      document.getElementById('modalEntry').value = "";
      document.getElementById('modalDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('previewImg').style.display = 'none';
      document.querySelectorAll('.mood-icon').forEach(el => el.classList.remove('selected'));
      document.getElementById('entryModal').style.display = 'flex';
    }

    function handleImage(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          currentImgBase64 = ev.target.result;
          document.getElementById('previewImg').src = currentImgBase64;
          document.getElementById('previewImg').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    function saveEntry(){
      const text = document.getElementById('modalEntry').value, date = document.getElementById('modalDate').value;
      if(!text) return;
      const data = { text, date, image: currentImgBase64, mood: currentMoodIdx };
      if(editingIndex === -1) entries.unshift(data); else entries[editingIndex] = data;
      entries.sort((a,b) => new Date(b.date) - new Date(a.date));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      document.getElementById('entryModal').style.display = 'none';
      renderPage();
    }

    function editEntry(idx){
      editingIndex = idx; const item = entries[idx];
      document.getElementById('modalEntry').value = item.text;
      document.getElementById('modalDate').value = item.date;
      selectMood(item.mood);
      if(item.image) {
        currentImgBase64 = item.image;
        document.getElementById('previewImg').src = item.image;
        document.getElementById('previewImg').style.display = 'block';
      } else {
        currentImgBase64 = "";
        document.getElementById('previewImg').style.display = 'none';
      }
      document.getElementById('entryModal').style.display = 'flex';
    }

    function deleteEntry(idx){
      if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){
        entries.splice(idx,1);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        renderPage();
      }
    }

    function cancelEdit(){ document.getElementById('entryModal').style.display = 'none'; }

    function waitTwoFrames(){
      return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    }

    async function exportPDF(){
      // æœªé€šé—œä¸å…è¨±åŒ¯å‡ºï¼ˆé¿å…ä»»ä½•æ—è·¯ï¼‰
      if(!isAuthenticated){
        document.getElementById('passwordModal').style.display = 'flex';
        return;
      }

      const mask = document.getElementById('privacy-mask');
      const container = document.getElementById('pdf-hidden-area');

      // æª¢æŸ¥æ¨¡çµ„
      if (!window.html2canvas) {
        alert("PDF æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼šhtml2canvas ä¸å­˜åœ¨ï¼ˆè«‹ç¢ºèªç¶²è·¯å¯é€£åˆ° cdnjsï¼‰");
        return;
      }
      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("PDF æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼šjsPDF ä¸å­˜åœ¨ï¼ˆè«‹ç¢ºèªç¶²è·¯å¯é€£åˆ° cdnjsï¼‰");
        return;
      }

      // çµ„ PDF å…§å®¹ï¼šåˆ†é å®¹å™¨ï¼ˆé¿å… iOS è¶…é•· canvas è®Šç©ºç™½ï¼‰
      container.innerHTML = "";
      const pageHeightPx = 1125;

      const makePage = () => {
        const p = document.createElement('div');
        p.className = "pdf-page";
        return p;
      };

      let current = makePage();
      const title = document.createElement('div');
      title.className = "pdf-title";
      title.textContent = "æˆ‘çš„æ‰‹å¸³æ—¥è¨˜";
      current.appendChild(title);

      const formatDate = (s) => (s || "").replaceAll('-', '/');

      // å…ˆæŠŠ DOM å»ºèµ·ä¾†ï¼ˆopacity 0 ä»æœƒ layoutï¼‰
      entries.forEach(item => {
        const entry = document.createElement('div');
        entry.className = "pdf-entry";

        const header = document.createElement('div');
        header.className = "pdf-entry-header";
        const left = document.createElement('span');
        left.textContent = formatDate(item.date);
        const right = document.createElement('span');
        right.textContent = (item.mood !== undefined && item.mood !== -1) ? MOODS[item.mood] : "";
        header.appendChild(left);
        header.appendChild(right);

        const text = document.createElement('div');
        text.className = "pdf-entry-text";
        text.textContent = item.text || "";

        entry.appendChild(header);
        entry.appendChild(text);

        if (item.image) {
          const img = document.createElement('img');
          img.src = item.image;
          entry.appendChild(img);
        }

        current.appendChild(entry);

        // è¶…éä¸€é å°±æ›é ï¼šæŠŠæœ€å¾Œä¸€å€‹ entry ç§»åˆ°æ–°é 
        if (current.scrollHeight > pageHeightPx) {
          current.removeChild(entry);
          container.appendChild(current);

          current = makePage();
          current.appendChild(entry);
        }
      });
      container.appendChild(current);

      // é¡¯ç¤ºé®ç½©ï¼ˆä½¿ç”¨è€…åªçœ‹åˆ°é€™å€‹ï¼‰
      mask.style.display = "flex";

      // ç­‰å¾…åœ–ç‰‡è¼‰å…¥
      const imgs = Array.from(container.querySelectorAll('img'));
      await Promise.all(imgs.map(imgEl => new Promise(resolve => {
        if (imgEl.complete) return resolve();
        imgEl.onload = () => resolve();
        imgEl.onerror = () => resolve();
      })));

      await waitTwoFrames();

      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          unit: 'mm',
          format: 'a4',
          orientation: 'portrait',
          encryption: { userPassword: DIARY_PASSWORD, ownerPassword: DIARY_PASSWORD }
        });

        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const margin = 10;
        const contentW = pageW - margin * 2;
        const contentH = pageH - margin * 2;

        const pages = Array.from(container.querySelectorAll('.pdf-page'));

        for (let i = 0; i < pages.length; i++) {
          const el = pages[i];

          const canvas = await window.html2canvas(el, {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff',
            windowWidth: 800,
            onclone: (clonedDoc) => {
              // clone è£¡ï¼šæŠŠ pdf å€å¡Šé‚„åŸå¯è¦‹ã€æŠŠé®ç½©é—œæ‰ï¼Œé¿å…ã€Œè¢«é®ä½å°±ä¸ paintã€å°è‡´ç©ºç™½
              const c = clonedDoc.getElementById('pdf-hidden-area');
              if (c) c.style.opacity = '1';
              const m = clonedDoc.getElementById('privacy-mask');
              if (m) m.style.display = 'none';
            }
          });

          const imgData = canvas.toDataURL('image/jpeg', 0.95);

          // è®“å½±åƒå®Œæ•´å¡é€² A4 å…§å®¹å€ï¼ˆç­‰æ¯”ç¸®æ”¾ï¼‰
          let drawW = contentW;
          let drawH = (canvas.height * drawW) / canvas.width;

          if (drawH > contentH) {
            drawH = contentH;
            drawW = (canvas.width * drawH) / canvas.height;
          }

          const x = margin + (contentW - drawW) / 2;
          const y = margin;

          if (i > 0) pdf.addPage();
          pdf.addImage(imgData, 'JPEG', x, y, drawW, drawH);
        }

        pdf.save('My-Diary.pdf');
      } catch (err) {
        console.error(err);
        alert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡");
      } finally {
        mask.style.display = "none";
        container.innerHTML = "";
      }
    }

    window.onload = renderPage;
  </script>
</body>
</html>
